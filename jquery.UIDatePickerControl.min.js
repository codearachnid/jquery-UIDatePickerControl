/**
 * jQuery UIDatePickerControl v0.9
 *
 * A simple plugin to organize events in a daily view and positioned 
 * in relationship to each other.
 * 
 * @author Timothy Wood @codearachnid <tim@imaginesimplicity.com>
 * @license GPLV3
 * @requires jquery.nearest, jquery.event.swipe, jquery.event.move, jquery.dateFormat
 * 
 */

!function(a,b,c,d){function g(b,c){this.element=b,this.settings=a.extend({},f,c),this._defaults=f,this._name=e,this._debug=this.settings.debug,this._selected=new Date,this.init()}var e="UIDatePickerControl",f={debug:!1,itemHeight:"50px",visibleRange:5,fullRange:90,selectedClass:"active",complete:!1};g.prototype={init:function(){this._debug&&(console.time(this._name+"-init"),console.log(this._name+".init()")),self=this,self.getDateTime(),self.controlSetup(),self.setDateTime(),self.swipeHandler(),self.complete(),a(self.element).find(".datetime").on("change",function(){self.update()}),this._debug&&console.timeEnd(this._name+"-init")},update:function(){this._debug&&(console.time(this._name+"-update"),console.log(this._name+".update()")),self.getDateTime(),self.dateControl(),self.setDateTime(),self.swipeHandler(),self.complete(),this._debug&&console.timeEnd(this._name+"-update")},complete:function(){"function"==typeof this.settings.complete&&this.settings.complete.call(this)},swipeHandler:function(){var c,d,e,b=0,f={top:0,left:0};self=this,a(this.element).find(".items").on("swipeup",function(){}).on("movestart",function(b){return b.distX>b.distY&&b.distX>-b.distY||b.distX<b.distY&&b.distX<-b.distY?(b.preventDefault(),void 0):(d=a(b.target).parent(),f=d.offset(),e=d.outerHeight(),c=a(b.target).parents(".control").find(".selected"),d.children().removeClass(self.settings.selectedClass),a(this).addClass("notransition"),void 0)}).on("move",function(a){var g=f.top+a.distY;b=0,(a.distY<0||a.distY>0)&&(b=a.distY<0?-1:-2,c.offset().top+c.outerHeight()<=parseInt(g)+parseInt(e)&&c.offset().top>=parseInt(g)&&d.offset({top:g}))}).on("moveend",function(){a(this).removeClass("notransition"),d.children().removeClass(self.settings.selectedClass),touching=c.touching().map(function(b,c){return a(c).hasClass("item")?c:void 0}),intendedElement=a(touching[touching.length+b]),d.animate({top:c.offset().top-intendedElement.offset().top+d.position().top},{complete:function(){switch(changedValue=intendedElement.addClass(self.settings.selectedClass).attr("data-value"),control=d.parent(),control.attr("data-type")){case"date":pattern=/(\d{4})-(\d{2})-(\d{2})/,dateArray=pattern.exec(changedValue),self._selected.setFullYear(+dateArray[1]),self._selected.setMonth(+dateArray[2]-1),self._selected.setDate(+dateArray[3]),self.dateControl(intendedElement);break;case"hour":mode=control.attr("data-mode"),mode="undefined"!=typeof mode&&mode!==!1?parseInt(control.attr("data-mode")):24,24==mode?self._selected.setHours(changedValue):(currentHour=self._selected.getHours(),12>=currentHour?self._selected.setHours(changedValue):self._selected.setHours(parseInt(changedValue)+12));break;case"minute":self._selected.setMinutes(changedValue);break;case"meridiem":currentHour=self._selected.getHours(),"AM"==changedValue?self._selected.setHours(currentHour-12):self._selected.setHours(currentHour+12)}self.saveDateTime()}})})},controlSetup:function(){this._debug&&(console.time(this._name+"-controlSetup"),console.log(this._name+".controlSetup()")),self=this,a(this.element).find(".control").each(function(b,c){switch(c=a(c),dom=[],items=[],c.attr("data-type")){case"date":self.dateControl();break;case"hour":mode=c.attr("data-mode"),mode="undefined"!=typeof mode&&mode!==!1?parseInt(c.attr("data-mode")):24;for(var b=0;mode>b;b++)items.push(self.option(b+1));break;case"minute":increment=c.attr("data-increment"),increment="undefined"!=typeof increment&&increment!==!1?parseInt(c.attr("data-increment")):1,minutesInDay=60/parseInt(increment);for(var b=0;minutesInDay>b;b++)value=0==b?"00":b*increment,items.push(self.option(value));break;case"meridiem":items=items.concat([self.option("AM"),self.option("PM")])}0==c.find(".selected").length&&dom.push(a("<div>").addClass("selected")),items.length>0&&dom.push(a("<div>").addClass("items").append(items)),dom.length>0&&c.append(dom),c.find(".items").index()<c.find(".selected").index()&&c.append(c.children().get().reverse())}),this._debug&&console.timeEnd(this._name+"-controlSetup")},dateControl:function(b){b=b||!1,control=a(this.element).find(".control[data-type=date]");var c=[];if(b){itemsElement=control.find(".items"),intendedElementIndex=b.index(),directionLength=Math.round(this.settings.visibleRange/2);var d=Date.prototype.getDateRange(this._selected.addDays(-Math.round(this.settings.fullRange/2)-directionLength),this._selected.addDays(-1));prependItems=this.dateOptions(d);var e=Date.prototype.getDateRange(this._selected.addDays(1),this._selected.addDays(Math.round(this.settings.fullRange/2)+directionLength));appendItems=this.dateOptions(e),control.find(".item:gt("+(intendedElementIndex+directionLength)+")").remove(),control.find(".item:lt("+(intendedElementIndex-directionLength)+")").remove(),itemsElement.prepend(prependItems).append(appendItems),itemsElement.offset({top:control.find(".selected").offset().top-b.offset().top+itemsElement.offset().top})}else{var f=Date.prototype.getDateRange(this._selected.addDays(-Math.round(this.settings.fullRange/2)),this._selected.addDays(Math.round(this.settings.fullRange/2)));c=this.dateOptions(f),0==control.find(".items").length?control.append(a("<div>").addClass("items").append(c)):control.find(".items").html("").append(c)}},dateOptions:function(b){for(var c=[],d=0;d<b.length;d++)label=a.format.date(b[d],"ddd MMM D"),value=a.format.date(b[d],"yyyy-MM-dd"),c.push(this.option(value,label));return c},option:function(b,c){return c=c||b,a("<div>").addClass("item").attr("data-value",b).text(c)},setDateTime:function(){control={},control.minute=a(this.element).find(".control[data-type=minute]"),minutesInDay=this.padNumber(parseInt(control.minute.attr("data-increment"))*Math.round(this._selected.getMinutes()/parseInt(control.minute.attr("data-increment"))),2),"60"==minutesInDay&&(minutesInDay="00",this._selected.setHours(this._selected.getHours()+1)),control.minute.find(".items").offset({top:control.minute.find(".selected").offset().top-control.minute.find(".item[data-value="+minutesInDay+"]").addClass(this.settings.selectedClass).position().top}),control.hour=a(this.element).find(".control[data-type=hour]"),this._selected.getHours()>12?(hoursInDay=this._selected.getHours()-12,meridiemInDay="PM"):(hoursInDay=this._selected.getHours(),meridiemInDay="AM"),control.hour.find(".items").offset({top:control.hour.find(".selected").offset().top-control.hour.find(".item[data-value="+hoursInDay+"]").addClass(this.settings.selectedClass).position().top}),control.meridiem=a(this.element).find(".control[data-type=meridiem]"),control.meridiem.find(".items").offset({top:control.meridiem.find(".selected").offset().top-control.meridiem.find(".item[data-value="+meridiemInDay+"]").addClass(this.settings.selectedClass).position().top}),control.date=a(this.element).find(".control[data-type=date]"),currentDate=this._selected.getFullYear()+"-"+this.padNumber(this._selected.getMonth()+1,2)+"-"+this.padNumber(this._selected.getDate(),2),control.date.find(".items").offset({top:control.date.find(".selected").offset().top-control.date.find(".item[data-value="+currentDate+"]").addClass(this.settings.selectedClass).position().top})},getDateTime:function(){return dateTime=a(this.element).find(".datetime").val(),0==dateTime||"undefined"==typeof dateTime?!1:(pattern=/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/,dateArray=pattern.exec(dateTime),this._selected=new Date(+dateArray[1],+dateArray[2]-1,+dateArray[3],+dateArray[4],+dateArray[5],+dateArray[6]),console.log("Get date/time: "+this._selected),void 0)},saveDateTime:function(){dateTime=this._selected.getFullYear()+"-"+this.padNumber(this._selected.getMonth()+1,2)+"-"+this.padNumber(this._selected.getDate(),2)+" "+this.padNumber(this._selected.getHours(),2)+":"+this.padNumber(this._selected.getMinutes(),2)+":00",a(this.element).find(".datetime").val(dateTime),console.log("Set date/time: "+dateTime)},padNumber:function(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a}},Date.prototype.addDays=function(a){var b=new Date(this.valueOf());return b.setDate(b.getDate()+a),b},Date.prototype.getDateRange=function(a,b,c){c=c||1;for(var d=[],a=new Date(a),b=new Date(b);b>=a;)d.push(a),a=Date.prototype.addDays.call(a,c);return d},a.fn[e]=function(b){var c=arguments;if(b===d||"object"==typeof b)return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new g(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var f;return this.each(function(){var d=a.data(this,"plugin_"+e);d instanceof g&&"function"==typeof d[b]&&(f=d[b].apply(d,Array.prototype.slice.call(c,1))),"destroy"===b&&a.data(this,"plugin_"+e,null)}),f!==d?f:this}}}(jQuery,window,document);
